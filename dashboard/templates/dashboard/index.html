{% extends "global/base.html" %} {% load static %} {% block content %}

<nav class="w-full border-b border-gray-300 bg-white">
  <div class="max-w-7xl mx-auto p-4 flex items-center justify-between">
    <div
      class="flex items-center gap-3 cursor-pointer transitions-opcaity hover:opacity-80"
      onclick="location.href='{% url 'dashboard:index' %}'"
    >
      <img src="{% static 'images/logo.svg' %}" alt="Logo" class="w-8 h-8" />
      <span class="font-semibold text-lg max-md:hidden">AniverLembre</span>
    </div>
    <div class="flex items-center gap-2">
      <div class="relative">
        <button
          id="profileDropdownBtn"
          class="flex items-center gap-2 px-3 py-2 rounded-full bg-white hover:bg-gray-100 outline-none transition-colors"
        >
          <div
            class="w-8 h-8 rounded-full bg-indigo-600 text-white font-semibold flex items-center justify-center flex-shrink-0"
          >
            {{ user.username|slice:":1"|upper }}
          </div>
          <span class="text-sm font-medium text-gray-700"
            >{{ user.username }}</span
          >
          <span
            class="material-symbols-outlined text-gray-500 text-base flex-shrink-0"
          >
            expand_more
          </span>
        </button>

        <div
          id="profileDropdown"
          class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 border z-50"
        >
          <a
            href="{% url 'accounts:profile' %}"
            class="block px-4 py-2 text-sm text-gray-700 font-medium hover:bg-gray-100"
          >
            <span
              class="material-symbols-outlined text-gray-600 text-sm align-middle mr-2"
              >person</span
            >
            Perfil
          </a>
          <a
            href="{% url 'accounts:logout' %}"
            class="block px-4 py-2 text-sm text-red-700 font-medium hover:bg-gray-100"
          >
            <span
              class="material-symbols-outlined text-red-600 text-sm align-middle mr-2 text-medium"
              >logout</span
            >
            Sair
          </a>
        </div>
      </div>
    </div>
  </div>
</nav>

<main class="max-w-7xl mx-auto px-4 py-6">
  <div class="flex items-center justify-between mb-6 gap-3 flex-wrap">
    <div>
      <h1 class="text-3xl font-bold text-gray-900">Seus Lembretes</h1>
    </div>
    <button
      id="openCreateDialog"
      class="flex items-center gap-2 px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 transition-colors shadow-sm"
    >
      <span class="material-symbols-outlined text-lg">add_circle</span>
      Novo Lembrete
    </button>
  </div>
  {% if reminders %}
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
    {% for r in reminders %}
    <div
      class="group relative rounded-2xl border border-gray-100 shadow-sm bg-white overflow-hidden"
      data-reminder-card
    >
      <div class="absolute inset-0 bg-gradient-to-br from-indigo-50 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
      <div class="relative p-4 space-y-3">
        <div class="flex items-start justify-between gap-3">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-full bg-indigo-600 text-white font-semibold flex items-center justify-center">
              {{ r.contact.name|slice:":1"|upper }}
            </div>
            <div>
              <h3 class="font-semibold text-gray-900">{{ r.contact.name }}</h3>
              <p class="text-sm text-gray-600 flex items-center gap-1">
                <span class="material-symbols-outlined text-base text-indigo-500">cake</span>
                {{ r.contact.birthday|date:"d/m" }}
              </p>
            </div>
          </div>
          <span
            class="text-xs px-2 py-1 rounded-full border {{ r.active|yesno:'bg-green-50 text-green-700 border-green-200,bg-gray-50 text-gray-700 border-gray-200' }}"
            >{{ r.active|yesno:'Ativo,Inativo' }}</span
          >
        </div>

        {% if r.contact.relationship or r.contact.notes %}
        <div class="text-sm text-gray-700 space-y-1">
          {% if r.contact.relationship %}
          <p class="flex items-center gap-2 text-gray-600">
            <span class="material-symbols-outlined text-base text-indigo-500">diversity_1</span>
            {{ r.contact.relationship }}
          </p>
          {% endif %}
          {% if r.contact.notes %}
          <p class="flex items-start gap-2 text-gray-600">
            <span class="material-symbols-outlined text-base text-indigo-500 mt-0.5">notes</span>
            <span class="line-clamp-2">{{ r.contact.notes }}</span>
          </p>
          {% endif %}
        </div>
        {% endif %}

        <div class="flex items-center justify-between pt-2 border-t border-gray-100 text-sm">
          <div class="flex flex-col text-gray-700">
            <span class="flex items-center gap-1">
              <span class="material-symbols-outlined text-base text-indigo-500">notifications_active</span>
              {{ r.notify_at|time:"H:i" }}
            </span>
            <span class="text-gray-500">{{ r.days_before }} dia{{ r.days_before|pluralize:"s" }} antes</span>
          </div>
          <div class="flex items-center gap-2">
            <button
              type="button"
              class="flex items-center gap-1 px-3 py-1.5 rounded-lg border border-gray-200 text-gray-700 hover:border-indigo-200 hover:text-indigo-700 transition-colors text-sm"
              data-edit-reminder
              data-reminder-id="{{ r.id }}"
              data-name="{{ r.contact.name|escape }}"
              data-birthday="{{ r.contact.birthday|date:'Y-m-d' }}"
              data-relationship="{{ r.contact.relationship|default_if_none:''|escape }}"
              data-notes="{{ r.contact.notes|default_if_none:''|escape }}"
              data-days-before="{{ r.days_before }}"
              data-notify-at="{{ r.notify_at|time:'H:i' }}"
              data-active="{{ r.active }}"
            >
              <span class="material-symbols-outlined text-base">edit</span>
              Editar
            </button>

            <form
              method="post"
              action="{% url 'dashboard:delete_reminder' r.id %}"
              onsubmit="return confirm('Deseja excluir este lembrete?');"
            >
              {% csrf_token %}
              <button
                type="submit"
                class="flex items-center gap-1 px-3 py-1.5 rounded-lg border border-red-200 text-red-700 hover:border-red-300 hover:bg-red-50 transition-colors text-sm"
              >
                <span class="material-symbols-outlined text-base">delete</span>
                Excluir
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <p class="text-gray-600">Você ainda não tem lembretes. Crie o primeiro!</p>
  {% endif %}
</main>

<dialog
  id="createDialog"
  class="rounded-lg max-w-2xl w-5/6 p-0 backdrop:bg-black backdrop:bg-opacity-50 px-4"
>
  <div class="bg-white rounded-lg">
    <div class="flex justify-between items-center px-6 py-4 border-b">
      <h3 class="text-xl font-semibold text-gray-800" id="dialogTitle">{% if is_editing %}Editar Lembrete{% else %}Novo Lembrete{% endif %}</h3>
      <button
        id="closeCreateDialog"
        class="text-gray-400 hover:text-gray-600 transition-colors"
      >
        <span class="material-symbols-outlined">close</span>
      </button>
    </div>
    <form
      method="post"
      action="{% url 'dashboard:create_reminder' %}"
      class="px-6 py-4 space-y-4"
    >
      {% csrf_token %}
      <input type="hidden" name="reminder_id" id="reminderIdField" value="{{ current_reminder_id|default:'' }}" />

      <div class="space-y-4">
        <h4
          class="text-base font-semibold text-gray-700 flex items-center gap-2"
        >
          <span class="material-symbols-outlined text-indigo-600">person</span>
          Informações do Contato
        </h4>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div class="flex flex-col">
            <label class="mb-1 font-medium text-sm text-gray-700"
              >{{ contact_form.name.label }} *</label
            >
            {{ contact_form.name }} {% if contact_form.name.errors %}
            <div class="text-red-600 text-xs mt-1">
              {% for error in contact_form.name.errors %}
              <p>{{ error }}</p>
              {% endfor %}
            </div>
            {% endif %}
          </div>

          <div class="flex flex-col">
            <label class="mb-1 font-medium text-sm text-gray-700"
              >{{ contact_form.birthday.label }} *</label
            >
            {{ contact_form.birthday }} {% if contact_form.birthday.errors %}
            <div class="text-red-600 text-xs mt-1">
              {% for error in contact_form.birthday.errors %}
              <p>{{ error }}</p>
              {% endfor %}
            </div>
            {% endif %}
          </div>

          <div class="flex flex-col sm:col-span-2">
            <label class="mb-1 font-medium text-sm text-gray-700"
              >{{ contact_form.relationship.label }}</label
            >
            {{ contact_form.relationship }} 
            {% if contact_form.relationship.errors %}
            <div class="text-red-600 text-xs mt-1">
              {% for error in contact_form.relationship.errors %}
              <p>{{ error }}</p>
              {% endfor %}
            </div>
            {% endif %}
          </div>

          <div class="flex flex-col sm:col-span-2">
            <label class="mb-1 font-medium text-sm text-gray-700"
              >{{ contact_form.notes.label }}</label
            >
            {{ contact_form.notes }} {% if contact_form.notes.errors %}
            <div class="text-red-600 text-xs mt-1">
              {% for error in contact_form.notes.errors %}
              <p>{{ error }}</p>
              {% endfor %}
            </div>
            {% endif %}
          </div>
        </div>
      </div>

      <div class="border-t"></div>

      <div class="space-y-4">
        <h4
          class="text-base font-semibold text-gray-700 flex items-center gap-2"
        >
          <span class="material-symbols-outlined text-indigo-600"
            >notifications</span
          >
          Configurações do Lembrete
        </h4>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div class="flex flex-col">
            <label class="mb-1 font-medium text-sm text-gray-700"
              >{{ reminder_form.days_before.label }} *</label
            >
            {{ reminder_form.days_before }}
            {% if reminder_form.days_before.errors %}
            <div class="text-red-600 text-xs mt-1">
              {% for error in reminder_form.days_before.errors %}
              <p>{{ error }}</p>
              {% endfor %}
            </div>
            {% endif %}
          </div>

          <div class="flex flex-col">
            <label class="mb-1 font-medium text-sm text-gray-700"
              >{{ reminder_form.notify_at.label }} *</label
            >
            {{ reminder_form.notify_at }}
            {% if reminder_form.notify_at.errors %}
            <div class="text-red-600 text-xs mt-1">
              {% for error in reminder_form.notify_at.errors %}
              <p>{{ error }}</p>
              {% endfor %}
            </div>
            {% endif %}
          </div>

          <div class="flex items-center gap-2 sm:col-span-2">
            {{ reminder_form.active }}
            <label
              for="id_active"
              class="text-sm font-medium text-gray-700 cursor-pointer"
              >{{ reminder_form.active.label }}</label
            >
            {% if reminder_form.active.errors %}
            <div class="text-red-600 text-xs mt-1">
              {% for error in reminder_form.active.errors %}
              <p>{{ error }}</p>
              {% endfor %}
            </div>
            {% endif %}
          </div>
        </div>
      </div>

      <div class="flex justify-end max-md:justify-center gap-3 pt-4 border-t">
        <button
          type="button"
          id="cancelCreate"
          class="px-6 py-2.5 rounded-lg border border-gray-300 text-gray-700 font-medium hover:bg-gray-50 transition-colors"
        >
          Cancelar
        </button>
        <button
          type="submit"
          id="saveReminderBtn"
          class="px-6 py-2.5 rounded-lg bg-indigo-600 text-white font-semibold hover:bg-indigo-700 transition-colors flex items-center gap-2 disabled:opacity-70 disabled:cursor-not-allowed"
        >
          <span
            class="material-symbols-outlined text-sm animate-spin hidden"
            id="saveSpinner"
            >progress_activity</span
          >
          <span id="saveText">Salvar</span>
        </button>
      </div>
    </form>
  </div>
</dialog>

<script>
  const createDialog = document.getElementById("createDialog");
  const openCreateBtn = document.getElementById("openCreateDialog");
  const closeCreateBtn = document.getElementById("closeCreateDialog");
  const cancelCreateBtn = document.getElementById("cancelCreate");

  function openCreate() {
    if (createDialog) createDialog.showModal();
  }
  function closeCreate() {
    if (createDialog) createDialog.close();
  }

  function resetFormToCreate() {
    document.getElementById("dialogTitle").textContent = "Novo Lembrete";
    document.getElementById("saveText").textContent = "Salvar";
    document.getElementById("reminderIdField").value = "";

    const fieldsToClear = [
      "id_name",
      "id_birthday",
      "id_relationship",
      "id_notes",
      "id_days_before",
      "id_notify_at",
    ];

    fieldsToClear.forEach((fieldId) => {
      const field = document.getElementById(fieldId);
      if (!field) return;
      if (field.type === "textarea") {
        field.value = "";
      } else {
        field.value = field.getAttribute("value") || "";
      }
    });

    const activeCheckbox = document.getElementById("id_active");
    if (activeCheckbox) activeCheckbox.checked = true;
  }

  if (openCreateBtn)
    openCreateBtn.addEventListener("click", () => {
      resetFormToCreate();
      openCreate();
    });
  if (closeCreateBtn)
    closeCreateBtn.addEventListener("click", (e) => {
      e.preventDefault();
      closeCreate();
    });
  if (cancelCreateBtn)
    cancelCreateBtn.addEventListener("click", (e) => {
      e.preventDefault();
      resetFormToCreate();
      closeCreate();
    });

  // Manter o dialog aberto se houver erros
  {% if show_dialog %}
  setTimeout(() => {
    openCreate();
  }, 100);
  {% endif %}

  const createForm = document.querySelector(
    "form[action=\"{% url 'dashboard:create_reminder' %}\"]"
  );
  const saveReminderBtn = document.getElementById("saveReminderBtn");
  const saveSpinner = document.getElementById("saveSpinner");
  const saveText = document.getElementById("saveText");
  const dialogTitle = document.getElementById("dialogTitle");
  const reminderIdField = document.getElementById("reminderIdField");

  if (createForm && saveReminderBtn) {
    createForm.addEventListener("submit", function (e) {
      saveReminderBtn.disabled = true;
      saveSpinner.classList.remove("hidden");
      saveText.textContent = "Salvando...";
    });
  }

  // Editar com o mesmo diálogo
  document.querySelectorAll("[data-edit-reminder]").forEach((btn) => {
    btn.addEventListener("click", () => {
      const dataset = btn.dataset;

      dialogTitle.textContent = "Editar Lembrete";
      saveText.textContent = "Atualizar";
      reminderIdField.value = dataset.reminderId || "";

      const map = {
        id_name: dataset.name,
        id_birthday: dataset.birthday,
        id_relationship: dataset.relationship,
        id_notes: dataset.notes,
        id_days_before: dataset.daysBefore,
        id_notify_at: dataset.notifyAt,
      };

      Object.entries(map).forEach(([id, value]) => {
        const el = document.getElementById(id);
        if (el && typeof value !== "undefined") {
          el.value = value;
        }
      });

      const activeCheckbox = document.getElementById("id_active");
      if (activeCheckbox) {
        activeCheckbox.checked = (dataset.active || "false").toString().toLowerCase() === "true";
      }

      openCreate();
    });
  });

  // Dropdown de Perfil
  const profileDropdownBtn = document.getElementById("profileDropdownBtn");
  const profileDropdown = document.getElementById("profileDropdown");

  if (profileDropdownBtn && profileDropdown) {
    profileDropdownBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      profileDropdown.classList.toggle("hidden");
    });

    document.addEventListener("click", (e) => {
      if (
        !profileDropdownBtn.contains(e.target) &&
        !profileDropdown.contains(e.target)
      ) {
        profileDropdown.classList.add("hidden");
      }
    });
  }
</script>

{% endblock %}
